class VimKeys{constructor(e={}){this.config={showStatus:!0,animationDuration:100,disabledKeys:[],language:"cn",...e},this.keyBuffer="",this.keyTimeout=null,this.isSearchActive=!1,this.statusElement=document.getElementById("vimStatus"),this.searchOverlay=document.getElementById("searchOverlay"),this.searchInput=document.getElementById("searchInput"),this.initI18n(),this.init()}initI18n(){this.i18n={cn:{ready:"就绪",keys:"按键",execute:"执行",searchMode:"搜索模式",confirmClose:"确定要关闭当前页面吗？",searchPlaceholder:"输入搜索内容...",searchClose:"按 ESC 关闭搜索",found:"找到匹配项",notFound:"未找到",deleteLine:"删除行功能（演示）",copyLine:"复制行功能（演示）"},en:{ready:"Ready",keys:"Keys",execute:"Execute",searchMode:"Search Mode",confirmClose:"Are you sure you want to close this page?",searchPlaceholder:"Enter search term...",searchClose:"Press ESC to close search",found:"Found match",notFound:"Not found",deleteLine:"Delete line function (demo)",copyLine:"Copy line function (demo)"}}}t(e){return this.i18n[this.config.language][e]||e}init(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),this.searchInput.addEventListener("keydown",this.handleSearchKeyDown.bind(this)),this.searchOverlay.addEventListener("click",this.handleOverlayClick.bind(this)),this.config.showStatus?this.updateStatus(this.t("ready")):this.statusElement&&(this.statusElement.style.display="none"),this.searchInput&&(this.searchInput.placeholder=this.t("searchPlaceholder"))}isInNonInteractiveMode(){const e=document.activeElement,t=e.tagName.toLowerCase();if(["input","textarea","select","button"].includes(t))return!1;if("true"===e.contentEditable)return!1;if("input"===t){const t=e.type.toLowerCase();if(["text","password","email","number","search","tel","url","date","datetime-local","month","time","week","color"].includes(t))return!1}return!this.isSearchActive}handleKeyDown(e){if(!this.isInNonInteractiveMode())return;if("Escape"===e.key&&this.isSearchActive)return this.closeSearch(),void e.preventDefault();["j","k","g","G","x","f","h","l","d","u"].includes(e.key)&&e.preventDefault(),this.config.disabledKeys.includes(e.key)||this.addKeyToBuffer(e.key)}handleKeyUp(e){this.isInNonInteractiveMode()}addKeyToBuffer(e){this.keyBuffer+=e,this.updateStatus(`${this.t("keys")}: ${this.keyBuffer}`),this.keyTimeout&&clearTimeout(this.keyTimeout);const t=this.executeCommand(this.keyBuffer);"executed"!==t?"waiting"!==t?"invalid"!==t||this.clearBuffer():this.keyTimeout=setTimeout(()=>{this.clearBuffer()},1e3):this.clearBuffer()}executeCommand(e){if(this.config.disabledKeys.includes(e))return"invalid";const t={gg:()=>this.scrollToTop()},i={...{j:()=>this.scrollSmooth(100),k:()=>this.scrollSmooth(-100),h:()=>this.scrollHorizontal(-50),l:()=>this.scrollHorizontal(50),G:()=>this.scrollToBottom(),x:()=>this.closePage(),f:()=>this.openSearch(),"/":()=>this.openSearch(),d:()=>this.pageDown(),u:()=>this.pageUp()},...t};if(i[e])return i[e](),this.updateStatus(`${this.t("execute")}: ${e}`),"executed";return Object.keys(t).filter(t=>t.startsWith(e)&&t.length>e.length).length>0?"waiting":"invalid"}clearBuffer(){this.keyBuffer="",this.updateStatus(this.t("ready")),this.keyTimeout&&(clearTimeout(this.keyTimeout),this.keyTimeout=null)}updateStatus(e){this.config.showStatus&&this.statusElement&&(this.statusElement.textContent=e)}getScrollBehavior(){return this.config.animationDuration>0?"smooth":"auto"}scrollSmooth(e){window.scrollBy({top:e,behavior:this.getScrollBehavior()})}scrollHorizontal(e){window.scrollBy({left:e,behavior:this.getScrollBehavior()})}scrollToTop(){window.scrollTo({top:0,behavior:this.getScrollBehavior()})}scrollToBottom(){window.scrollTo({top:document.documentElement.scrollHeight,behavior:this.getScrollBehavior()})}pageDown(){const e=window.innerHeight;window.scrollBy({top:e,behavior:this.getScrollBehavior()})}pageUp(){const e=window.innerHeight;window.scrollBy({top:-e,behavior:this.getScrollBehavior()})}closePage(){confirm(this.t("confirmClose"))&&(window.close(),setTimeout(()=>{window.closed||window.history.back()},100))}openSearch(){this.isSearchActive=!0,this.searchOverlay.style.display="block",this.searchInput.focus(),this.updateStatus(this.t("searchMode"))}closeSearch(){this.isSearchActive=!1,this.searchOverlay.style.display="none",this.searchInput.value="",this.clearSearchHighlights(),this.updateStatus(this.t("ready")),document.body.focus()}handleSearchKeyDown(e){"Escape"===e.key?(this.closeSearch(),e.preventDefault()):"Enter"===e.key&&(this.performSearch(),e.preventDefault())}handleOverlayClick(e){}performSearch(){const e=this.searchInput.value.trim();if(!e)return;this.clearSearchHighlights();const t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.parentElement.closest(".search-overlay")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),i=[];let s;for(;s=t.nextNode();)i.push(s);let o=null;i.forEach(t=>{const i=t.textContent,s=new RegExp(`(${this.escapeRegex(e)})`,"gi");if(s.test(i)){const e=t.parentElement,n=i.replace(s,'<mark class="search-highlight">$1</mark>'),r=document.createElement("div");for(r.innerHTML=n;r.firstChild;)e.insertBefore(r.firstChild,t);e.removeChild(t),o||(o=e.querySelector(".search-highlight"))}}),o?(o.scrollIntoView({behavior:this.getScrollBehavior(),block:"center"}),this.updateStatus(`${this.t("found")}: ${e}`)):this.updateStatus(`${this.t("notFound")}: ${e}`)}clearSearchHighlights(){document.querySelectorAll(".search-highlight").forEach(e=>{const t=e.parentElement;t.replaceChild(document.createTextNode(e.textContent),e),t.normalize()})}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}const style=document.createElement("style");style.textContent="\n  .search-highlight {\n    background-color: yellow;\n    color: black;\n    padding: 1px 2px;\n    border-radius: 2px;\n  }\n",document.head.appendChild(style),document.addEventListener("DOMContentLoaded",()=>{window.vimKeys=new VimKeys});