class VimKeys{constructor(e={}){this.config={showStatus:!0,animationDuration:100,disabledKeys:[],language:"cn",...e},this.keyBuffer="",this.keyTimeout=null,this.isSearchActive=!1,this.initI18n(),this.createElements(),this.init()}initI18n(){this.i18n={cn:{ready:"就绪",keys:"按键",execute:"执行",searchMode:"搜索模式",confirmClose:"确定要关闭当前页面吗？",searchPlaceholder:"输入搜索内容...",searchClose:"按 ESC 关闭搜索",found:"找到匹配项",notFound:"未找到",deleteLine:"删除行功能（演示）",copyLine:"复制行功能（演示）"},en:{ready:"Ready",keys:"Keys",execute:"Execute",searchMode:"Search Mode",confirmClose:"Are you sure you want to close this page?",searchPlaceholder:"Enter search term...",searchClose:"Press ESC to close search",found:"Found match",notFound:"Not found",deleteLine:"Delete line function (demo)",copyLine:"Copy line function (demo)"}}}t(e){return this.i18n[this.config.language][e]||e}createElements(){this.createStatusElement(),this.createSearchOverlay(),this.addStyles()}createStatusElement(){document.getElementById("vimStatus")?this.statusElement=document.getElementById("vimStatus"):(this.statusElement=document.createElement("div"),this.statusElement.id="vimStatus",this.statusElement.className="vim-status",this.statusElement.textContent=this.t("ready"),document.body.appendChild(this.statusElement))}createSearchOverlay(){if(document.getElementById("search-overlay"))return this.searchOverlay=document.getElementById("search-overlay"),void(this.searchInput=document.getElementById("search-input"));this.searchOverlay=document.createElement("div"),this.searchOverlay.id="search-overlay",this.searchOverlay.className="search-overlay",this.searchOverlay.style.display="none";const e=document.createElement("div");e.className="search-box",this.searchInput=document.createElement("input"),this.searchInput.id="search-input",this.searchInput.className="search-input",this.searchInput.type="text",this.searchInput.placeholder=this.t("searchPlaceholder");const t=document.createElement("p");t.style.margin="8px 0 0 0",t.style.color="#666",t.style.fontSize="12px",t.textContent=this.t("searchClose"),e.appendChild(this.searchInput),e.appendChild(t),this.searchOverlay.appendChild(e),document.body.appendChild(this.searchOverlay)}addStyles(){if(document.getElementById("vim-keys-styles"))return;const e=document.createElement("style");e.id="vim-keys-styles",e.textContent="\n      .vim-status {\n        position: fixed;\n        bottom: 10px;\n        right: 10px;\n        background: #333;\n        color: white;\n        padding: 8px 12px;\n        border-radius: 4px;\n        font-family: monospace;\n        font-size: 12px;\n        z-index: 9998;\n        user-select: none;\n        pointer-events: none;\n      }\n      \n      .search-overlay {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        width: 300px;\n        z-index: 9999;\n      }\n      \n      .search-box {\n        background: white;\n        padding: 15px;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n        border: 1px solid #ddd;\n      }\n      \n      .search-input {\n        width: 100%;\n        padding: 10px;\n        font-size: 16px;\n        border: 2px solid #ddd;\n        border-radius: 4px;\n        box-sizing: border-box;\n        outline: none;\n      }\n      \n      .search-input:focus {\n        border-color: #007cba;\n      }\n      \n      .search-highlight {\n        background-color: yellow;\n        color: black;\n        padding: 1px 2px;\n        border-radius: 2px;\n      }\n    ",document.head.appendChild(e)}init(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),this.searchInput.addEventListener("keydown",this.handleSearchKeyDown.bind(this)),this.searchOverlay.addEventListener("click",this.handleOverlayClick.bind(this)),this.config.showStatus?this.updateStatus(this.t("ready")):this.statusElement&&(this.statusElement.style.display="none")}isInNonInteractiveMode(){const e=document.activeElement,t=e.tagName.toLowerCase();if(["input","textarea","select","button"].includes(t))return!1;if("true"===e.contentEditable)return!1;if("input"===t){const t=e.type.toLowerCase();if(["text","password","email","number","search","tel","url","date","datetime-local","month","time","week","color"].includes(t))return!1}return!this.isSearchActive}handleKeyDown(e){if(!this.isInNonInteractiveMode())return;if("Escape"===e.key&&this.isSearchActive)return this.closeSearch(),void e.preventDefault();["j","k","g","G","x","f","h","l","d","u"].includes(e.key)&&e.preventDefault(),this.config.disabledKeys.includes(e.key)||this.addKeyToBuffer(e.key)}handleKeyUp(e){this.isInNonInteractiveMode()}addKeyToBuffer(e){this.keyBuffer+=e,this.updateStatus(`${this.t("keys")}: ${this.keyBuffer}`),this.keyTimeout&&clearTimeout(this.keyTimeout);const t=this.executeCommand(this.keyBuffer);"executed"!==t?"waiting"!==t?"invalid"!==t||this.clearBuffer():this.keyTimeout=setTimeout(()=>{this.clearBuffer()},1e3):this.clearBuffer()}executeCommand(e){if(this.config.disabledKeys.includes(e))return"invalid";const t={gg:()=>this.scrollToTop()},s={...{j:()=>this.scrollSmooth(100),k:()=>this.scrollSmooth(-100),h:()=>this.scrollHorizontal(-50),l:()=>this.scrollHorizontal(50),G:()=>this.scrollToBottom(),x:()=>this.closePage(),f:()=>this.openSearch(),"/":()=>this.openSearch(),d:()=>this.pageDown(),u:()=>this.pageUp()},...t};if(s[e])return s[e](),this.updateStatus(`${this.t("execute")}: ${e}`),"executed";return Object.keys(t).filter(t=>t.startsWith(e)&&t.length>e.length).length>0?"waiting":"invalid"}clearBuffer(){this.keyBuffer="",this.updateStatus(this.t("ready")),this.keyTimeout&&(clearTimeout(this.keyTimeout),this.keyTimeout=null)}updateStatus(e){this.config.showStatus&&this.statusElement&&(this.statusElement.textContent=e)}getScrollBehavior(){return this.config.animationDuration>0?"smooth":"auto"}scrollSmooth(e){window.scrollBy({top:e,behavior:this.getScrollBehavior()})}scrollHorizontal(e){window.scrollBy({left:e,behavior:this.getScrollBehavior()})}scrollToTop(){window.scrollTo({top:0,behavior:this.getScrollBehavior()})}scrollToBottom(){window.scrollTo({top:document.documentElement.scrollHeight,behavior:this.getScrollBehavior()})}pageDown(){const e=window.innerHeight;window.scrollBy({top:e,behavior:this.getScrollBehavior()})}pageUp(){const e=window.innerHeight;window.scrollBy({top:-e,behavior:this.getScrollBehavior()})}closePage(){confirm(this.t("confirmClose"))&&(window.close(),setTimeout(()=>{window.closed||window.history.back()},100))}openSearch(){this.isSearchActive=!0,this.searchOverlay.style.display="block",this.searchInput.focus(),this.updateStatus(this.t("searchMode"))}closeSearch(){this.isSearchActive=!1,this.searchOverlay.style.display="none",this.searchInput.value="",this.clearSearchHighlights(),this.updateStatus(this.t("ready")),document.body.focus()}handleSearchKeyDown(e){"Escape"===e.key?(this.closeSearch(),e.preventDefault()):"Enter"===e.key&&(this.performSearch(),e.preventDefault())}handleOverlayClick(e){}performSearch(){const e=this.searchInput.value.trim();if(!e)return;this.clearSearchHighlights();const t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.parentElement.closest(".search-overlay")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),s=[];let i;for(;i=t.nextNode();)s.push(i);let n=null;s.forEach(t=>{const s=t.textContent,i=new RegExp(`(${this.escapeRegex(e)})`,"gi");if(i.test(s)){const e=t.parentElement,o=s.replace(i,'<mark class="search-highlight">$1</mark>'),r=document.createElement("div");for(r.innerHTML=o;r.firstChild;)e.insertBefore(r.firstChild,t);e.removeChild(t),n||(n=e.querySelector(".search-highlight"))}}),n?(n.scrollIntoView({behavior:this.getScrollBehavior(),block:"center"}),this.updateStatus(`${this.t("found")}: ${e}`)):this.updateStatus(`${this.t("notFound")}: ${e}`)}clearSearchHighlights(){document.querySelectorAll(".search-highlight").forEach(e=>{const t=e.parentElement;t.replaceChild(document.createTextNode(e.textContent),e),t.normalize()})}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}